name: Fetch Key Vault Secrets

description: Action to Fetch Secrets stored in Azure Key Vault

inputs:
  keyvault:
    description: Name of the Key Vault the secrets are being stored
    required: true

  secrets:
    description: Comma-separated list of secret names to fetch values from
    required: true
outputs:
  secrets:
    description: "The fetched secrets from Azure Key Vault. Actual output names will be based on the secret names provided in the 'secrets' input."
    value: ${{ steps.set_outputs.outputs.secrets }}

runs:
  using: composite

  steps:
    - name: Fetch Key Vault Secrets
      shell: bash
      id: fetch_secrets
      run: |
        OUTPUT_FILE="outputs.txt"
        IFS=',' read -ra SECRET_NAMES <<< "${{ inputs.secrets }}"

        for SECRET_NAME in "${SECRET_NAMES[@]}"; do
          SECRET_VALUE=$(az keyvault secret show --name "$SECRET_NAME" --vault-name "${{ inputs.keyvault }}" --query "value" -o tsv)
          echo "::add-mask::$SECRET_VALUE"
          echo "$SECRET_NAME=$SECRET_VALUE" >> $OUTPUT_FILE
        done

    - name: Set Outputs
      id: set_outputs
      run: |
        echo "::set-output name=secrets::$(cat outputs.txt)"
