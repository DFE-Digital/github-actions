name: Check Service Principal
description:
inputs:
  AzureCredentials:
    description: 'Azure Credentials'
    required:    true
  ServicePrincipal:
    description: 'Service Principal you want to check'
    required:    true
  ExpiresWithinDays:
    description: 'Only print keys that expire within the input value (days)'
    required:    true
    default:     30
  TennantName:
    description: 'Tennant Name you want to check'
    required:    false
    default:     platform.education.gov.uk
outputs:
  json_data:
     value: ${{ steps.get_expiry.outputs.result }}
     description: Result in JSON format
runs:
  using: composite
  steps:
       - name: Get Expiry Date
         shell: pwsh
         id: get_expiry
         run: |
              function RefreshToken($loginURL, $clientId, $clientSecret, $tenantName) {
                  $body = @{grant_type = "client_credentials"; client_id = $clientId; client_secret = $clientSecret; scope = $env:SCOPE }
                  $oauthResponse = Invoke-RestMethod -Method POST -Uri $loginURL/$tenantName/oauth2/v2.0/token -Body $body
                  return $oauthResponse
              }

              $credentials = ( $env:AZURE_CREDENTIALS | ConvertFrom-Json )
              $body = @{ grant_type = "client_credentials"; client_id = $credentials.clientId; client_secret = $credentials.clientSecret; scope = $env:SCOPE }
              $oauth = RefreshToken -loginURL $env:LOGIN_URL  -resource $resource -clientId $credentials.clientId  -clientSecret $credentials.clientSecret -tenantName $env:TENNANT_NAME
              Write-Output "Connected with OAuth"
              $headerParams = @{ 'Authorization' = "$($oauth.token_type) $($oauth.access_token)" }
              $applicationsList = (Invoke-WebRequest -Headers $headerParams -Uri $env:APP_SECRETS -Method GET)
              $logs = @()
              $nextCounter = 0
              :servicePrincipalSearch do {
                  foreach ($event in ($applicationsList.Content | ConvertFrom-Json | select -ExpandProperty value)) {
                      $ids = $event.id
                      $appName = $event.displayName
                      $appSecrets = $event.passwordCredentials
                      $nextCounter++
                      if ( $appName -eq $env:SERVICE_PRINCIPAL ) {
                          Write-Output "Service Principal matching our search criteria '$($env:SERVICE_PRINCIPAL)' found with $($appSecrets.Count) secret(s)."
                          $appSecrets = $appSecrets | Sort-Object -Property endDateTime
                          foreach ( $secret in $appSecrets ) {
                              $now = Get-Date
                              $expires = ( New-TimeSpan -Start $now -End $secret.endDateTime).ToString("dd")
                              $log = New-Object System.Object
                              $log | Add-Member -MemberType NoteProperty -Name "Application" -Value $appName
                              $log | Add-Member -MemberType NoteProperty -Name "ExpiresDays" -Value $expires
                              $log | Add-Member -MemberType NoteProperty -Name "Name"        -Value $secret.displayName
                              $log | Add-Member -MemberType NoteProperty -Name "StartDate"   -Value $secret.startDateTime
                              $log | Add-Member -MemberType NoteProperty -Name "EndDate"     -Value $secret.endDateTime
                              Write-Output "Closest secret expiry date: $($secret.endDateTime.ToString("dd/MM/yyyy HH:MM:ss"))"
                              if ( [int]$expires -le [int]$env:EXPIRES_WITHIN_DAYS ) {
                                  Write-Output "Service principal secret '$($secret.displayName)' expires in $expires days"
                                  $log | Add-Member -MemberType NoteProperty -Name "Alert" -Value $true
                                  $logs += $log
                                  break servicePrincipalSearch
                              }
                              else {
                                  Write-Output "Service principal secret '$($secret.displayName)' expires in $expires days"
                                  $log | Add-Member -MemberType NoteProperty -Name "Alert" -Value $false
                                  $logs += $log
                                  break servicePrincipalSearch
                              }
                          }
                      }
                      If ( $nextCounter -eq 100 ) {
                          $odata = $applicationsList.Content | ConvertFrom-Json
                          $appsSecrets = $odata.'@odata.nextLink'
                          if ( $appsSecrets -ne $null) {
                               $applicationsList = Invoke-WebRequest -UseBasicParsing -Headers $headerParams -Uri $appsSecrets -Method Get -ContentType "application/Json"
                          }
                          $nextCounter = 0
                          sleep 1
                      }
                  }
              } while ($appsSecrets -ne $null)

              if ($expiringSecrets = $logs | Where-Object Alert -eq true) {
                  # If we have an expiring secret then return the details
                  Write-Output "Service principal has a secret that expires within $($env:EXPIRES_WITHIN_DAYS) days. Alert."
                  $result = ($expiringSecrets | ConvertTo-Json)
              }
              elseif (!$logs) {
                  # If we didn't find a service principal that matched then we don't need to alert
                  Write-Output "No matching service principals found."
                  $logs = New-Object System.Object
                  $logs | Add-Member -MemberType NoteProperty -Name "Alert" -Value $false
                  $result = ($logs | ConvertTo-Json)
              }
              else {
                  Write-Output "Service principal has no secrets expiring within specified period of $($env:EXPIRES_WITHIN_DAYS) days."
                  $result = ($logs[0] | ConvertTo-Json)
              }

              $json="{'data': $result }"
              Write-Output "::set-output name=result::$json"
              Write-Output "$result"
         env:
           LOGIN_URL:           "https://login.microsoftonline.com"
           APP_SECRETS:         "https://graph.microsoft.com/v1.0/applications"
           SCOPE:               "https://graph.microsoft.com/.default"
           AZURE_CREDENTIALS:   ${{INPUTS.AzureCredentials}}
           TENNANT_NAME:        ${{INPUTS.TennantName}}
           SERVICE_PRINCIPAL:   ${{INPUTS.ServicePrincipal}}
           EXPIRES_WITHIN_DAYS: ${{INPUTS.ExpiresWithinDays}}
